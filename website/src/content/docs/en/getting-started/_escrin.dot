digraph {
    graph [bgcolor="#1f2937", compound=true, fontname="Helvetica", color="#e2e5e9", fontcolor="#e2e5e9"];
    edge [fontname="Helvetica", color="#e2e5e9", fontcolor="#e2e5e9"];
    node [shape=record fontname="Helvetica", color="#e2e5e9", fontcolor="#e2e5e9"];

    orchestrator [label=<Orchestrator>];
    agent;
    storage [label=<Storage Network>];

    subgraph cluster_ledger {
        penwidth=2;
        label=<Decentralized Ledger>;
        agent [shape=none, label=<<TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="6">
            <tr><td>Agent Contract</td></tr>

            <TR><TD PORT="acceptTasks"><font color="#eeaa00" point-size="12">(escrin)  </font><font face="courier" point-size="12">acceptTasks(tasks,report,proof)</font></TD></TR>
            <TR><TD PORT="state"><font face="courier" point-size="12">public state</font></TD></TR>

            <TR><TD PORT="approveSecret"><font color="#eeaa00" point-size="12">(escrin)  </font><font face="courier" point-size="12">approveSecret(credentials)</font></TD></TR>
            </TABLE>>];
    }

    subgraph cluster_runner {
        label=<TEE-having Task Runner>;
        subgraph cluster_escrin {
            penwidth=2;
            pencolor="#eeaa00";
            label=<Escrin<br/><font point-size="12">(in a TEE)</font>>
                tasks [label=<Task|Task|...>];
        }
    }

    orchestrator -> agent:state  [label=<1. detect tasks<br/>&amp; policies>, style=dashed, constraint=false];
    orchestrator -> tasks [label=<2. dispatch tasks>, lhead=cluster_runner];

    km [label=<Secret Management Network>,penwidth=2];

    agent:approveSecret -> tasks [lhead=cluster_escrin, ltail=cluster_escrin, label=<4. request secret  >,dir=back,color="#eeaa00"];
    tasks -> storage [ltail=cluster_escrin,label=<3. fetch program &amp; inputs  >, style=dashed,color="#eeaa00"];
    tasks -> storage [ltail=cluster_escrin,label=<  7. store outputs>,color="#eeaa00"];
    tasks -> agent:acceptTasks [lhead=cluster_escrin, ltail=cluster_escrin, taillabel=<<br/>                     8. submit results>,constraint=false,color="#eeaa00"];
    km -> tasks [lhead=cluster_escrin, ltail=cluster_escrin, label=< 5.  fetch secret>, style=dashed, dir=back, color="#eeaa00"];
    agent:state -> km [xlabel=<<br/><br/>6. check secret approval>, dir=back, style=dashed];
}
